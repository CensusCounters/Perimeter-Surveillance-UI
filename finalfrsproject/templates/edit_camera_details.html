{% extends "layout.html" %}
{% block content %}
<section class="user user_register_section" style="padding-top:2em">
  <div class="row" id="img-vg-content">
      <div class="col-md-6">
        <div class="user-form">
          <form id="form" action="{{ url_for('edit_camera_details') }}" enctype="multipart/form-data" method="post">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="camera_id" value="{{ details.camera_id }}">
            <div class="row" id="img-vg-content-1">
                <div class="col-md-12">
                  <div class="form-group col-md-12" id="location_section">
                    <div class="col-md-4">
                        <label class="label">Location</label>
                    </div>
                   <div class="col-md-8">
                        <select name="camera_location" id="camera_location" class="form-control required" onchange="get_sub_locations(this.value,'','');">
                             <option value="">Camera Location</option>
                        </select>
                   </div>
                  </div>
                  <div class="form-group col-md-12" id="sub_location_section">
                      <div class="col-md-4">
                         <label class="label">Sub Location</label>
                      </div>
                      <div class="col-md-8">
                          <select name="camera_sub_location" id="camera_sub_location" class="form-control required">
                            <option value="">Camera Sub Location</option>
                          </select>
                      </div>
                  </div>
                  <div class="form-group col-md-12" id="camera_make_section">
                      <div class="col-md-4">
                          <label class="label">Camera Make</label>
                      </div>
                      <div class="col-md-8">
                          <select name="camera_make" id="camera_make" class="form-control required">
                              <option value="">Camera Make</option>
                              <option value="HikVision">HikVision</option>
                              <option value="CPPlus">CPPlus</option>
                              <option value="Dahua">Dahua</option>
                              <option value="Other">Other</option>
                          </select>
                      </div>
                  </div>
                  <div class="form-group col-md-12" id="camera_ip_section">
                     <div class="col-md-4">
                         <label class="label">IP address</label>
                     </div>
                     <div class="col-md-8">
                          <input id="camera_ip_address" name="camera_ip_address" type="text" class="form-control required" placeholder="Enter the Camera IP">
                     </div>
                  </div>
                  <div class="form-group col-md-12" id="camera_username_section">
                      <div class="col-md-4">
                          <label class="label">Username</label>
                      </div>
                      <div class="col-md-8">
                          <input id="camera_username" name="camera_username" type="text" class="form-control" placeholder="Enter the username for the camera">
                      </div>
                  </div>
                  <div class="form-group col-md-12" id="camera_password_section">
                      <div class="col-md-4">
                          <label class="label">Password</label>
                      </div>
                      <div class="col-md-8">
                          <input id="camera_password" name="camera_password" type="text" class="form-control" placeholder="Enter the password for the camera">
                      </div>
                  </div>
                  <div class="form-group col-xs-12" style="display:none">
                      <div class="col-md-4">
                          <label class="label">RTSP Address</label>
                      </div>
                      <div class="col-md-8">
                          <input id="camera_rtsp_address" name="camera_rtsp_address" type="text" class="form-control required" value="Camera RTSP - {{ details.camera_rtsp_address }}">
                      </div>
                  </div>
                  <div class="col-xs-12 buttons text-center" id="form_button_section">
                      <button type="button" id="submit_form" class="c-btn" style="width:75%">Submit</button>
                  </div>
                </div>
            </div>
          </form>
        </div>
      </div>
  </div>
</section>
<script>
 function show_alert_model(title, message) {
    Swal.fire({
        title: title,
        html: '<span style="font-size: 20px;font-color:"#ffd868">' + message + '</span>',
        confirmButtonText: 'OK',
        confirmButtonColor: '#3085d6',
        customClass: {
            popup: 'my-popup-class',
            confirmButton: 'my-confirm-button-class',
            title: 'my-title-class',
        }
    }).then((result) => {
        if (result.isConfirmed) {
            console.log('OK button was clicked');
            document.getElementById("camera_location").focus();
        }
    });
}


function get_sub_locations(location,sub_location,location_id) {
    console.log("location: ", location);
    if (location == '') {
        show_alert_model('Error','Please select a location to proceed');
        return;
    }
    $.ajax({
        url: "{{ url_for('get_sub_location_list') }}",
        type: "GET", // Type of Request
        data: {
            source: "edit_camera_details",
            need: "locations",
            location: location
        },
        success: function (data) {
            let sub_location_select_list = document.getElementById("camera_sub_location");
            for (var i=0; i<sub_location_select_list.length; i++) {
                if (sub_location_select_list.options[i].value != '') {
                    sub_location_select_list.remove(i)
                }
            }
            console.log(sub_location_select_list.length)
            let sub_location_list = JSON.stringify(data);
            let sub_location_list_json = JSON.parse(sub_location_list);
            console.log("sub location length: " , sub_location_list_json.length)

            for (var i = 0; i < sub_location_list_json.length; i++) {
                let option = document.createElement("option");
                option.value = sub_location_list_json[i].id+","+sub_location_list_json[i].sub_location_name;
                option.text = sub_location_list_json[i].sub_location_name;
                sub_location_select_list.appendChild(option);
            }
            if (sub_location != '' && location_id != '') {
                //selected_sub_location_from_database = "{{ details.camera_sub_location_name }}"
                //selected_location_id_from_database = "{{ details.camera_location_id }}"
                //console.log("sub_location: ", sub_location);
                //let sub_location_select_list = document.getElementById("camera_sub_location");
                sub_location_select_list.value = location_id + "," + sub_location;
                console.log("sub_location: ", sub_location_select_list.value);
            }
        },
      // Error handling
        error: function (xhr, status, errorThrown) {
            if (xhr.status === 500) { // Check if the error is 500
                var errorResponse = JSON.parse(xhr.responseText); // Parse the JSON response
                console.log("Error Message: ", errorResponse.message);
                show_alert_model('Error', errorResponse.message);
            } else {
                // Handle other types of errors
                show_alert_model('Error', errorResponse.message);
                console.log("An error occurred: ", status, errorThrown);
            }
        }
    });
}

$(document).ready(function(){

  document.getElementById("camera_make").value = "{{ details.camera_make }}";
  document.getElementById("camera_ip_address").value = "{{ details.camera_ip_address }}"
  document.getElementById("camera_username").value = "{{ details.camera_username }}"
  document.getElementById("camera_password").value = "{{ details.camera_password }}"
  document.getElementById("camera_rtsp_address").value = "{{ details.camera_rtsp_address }}"
  $.ajax({
      url: "{{ url_for('get_location_list') }}",
      type: "GET", // Type of Request,
      data: {
        source: "edit_camera",
        need: "locations"
      },
      success: function (data) {
        let location_select_list = document.getElementById("camera_location");
        let location_list = JSON.stringify(data);
        let location_list_json = JSON.parse(location_list);
        console.log("location length: " , location_list_json.length)

        for (var i = 0; i < location_list_json.length; i++) {
          let option = document.createElement("option");
          option.value = location_list_json[i].location_name;
          option.text = location_list_json[i].location_name;
          location_select_list.appendChild(option);
        }
        selected_location_from_database = "{{ details.camera_location_name }}"
        location_select_list.value = selected_location_from_database;
      },
      // Error handling
        error: function (xhr, status, errorThrown) {
            if (xhr.status === 500) { // Check if the error is 500
                var errorResponse = JSON.parse(xhr.responseText); // Parse the JSON response
                console.log("Error Message: ", errorResponse.message);
                show_alert_model('Error', errorResponse.message);
            } else {
                // Handle other types of errors
                show_alert_model('Error', errorResponse.message);
                console.log("An error occurred: ", status, errorThrown);
            }
        }
  });
  get_sub_locations("{{ details.camera_location_name }}","{{ details.camera_sub_location_name }}","{{ details.camera_location_id }}")


  $.validator.addMethod('IP4Checker', function(value) {
      return value.match(/^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/);
  }, 'Invalid IP address');

  $(document).keypress(function(e) {
    if(e.which == 13) {
      $("#submit_form").trigger("click");
    }
  });
  $("#submit_form").click(function() {
    if($('#form').valid()) {
      var form_element = document.getElementById('form');
      var input_var = document.createElement('input');
      input_var.type = 'hidden';
      input_var.name = 'submit_form';
      input_var.value = 'save';
      form_element.appendChild(input_var);
      form_element.submit();
    }
  });

  $("#form").validate({
    errorPlacement: function (error, element){
      element.before(error);
    },
    rules: {
      camera_location: {
        required : true
      },
      camera_ip_address: {
        required : true,
        IP4Checker: true
      },
      camera_make: {
        required : true
      },
      camera_username: {
          required : true
      },
      camera_password: {
          required : true
      },
      camera_rtsp_address: {
          required : true
      },

    }
  });
});
</script>
{% endblock content %}